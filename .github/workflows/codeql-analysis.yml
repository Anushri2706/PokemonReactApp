on:
  workflow_run:
    workflows: ["CodeQL"]
    types:
      - completed

jobs:
  create_issues:
    runs-on: ubuntu-latest
    permissions:
      security-events: read
      issues: write

# Downloading results of the CodeQL analysis
    steps:
      - name: Download CodeQL SARIF results
        uses: actions/download-artifact@v4
        with:
          name: codeql-sarif
          path: sarif-result
# Parsing SARIF and creating issues for high/critical findings
      - name: Parse SARIF and create issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const sarif = JSON.parse(fs.readFileSync("sarif-output/results.sarif", "utf8"));

            for (const run of sarif.runs) {
              for (const result of run.results) {
                const severity = result.level; // "error" == high/critical
                if (severity === "error") {
                  const message = result.message.text;
                  const ruleId = result.ruleId;
                  const issueTitle = `CodeQL: [${severity}] ${ruleId}`;
                  const issueBody = `
            **High/Critical CodeQL finding**

            **Rule:** ${ruleId}  
            **Message:** ${message}  
            **File:** ${result.locations?.[0]?.physicalLocation?.artifactLocation?.uri}
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  assignees: ["github-copilot-autofix"]
                  });
                }
              }
            }

