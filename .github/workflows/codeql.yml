name: My CodeQL scanner
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    paths-ignore:
      - ".github/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          output: ./codeql-results
          format: sarif

      - name: Upload SARIF results
        uses: actions/upload-artifact@v4
        with:
          name: codeql-sarif
          path: codeql-results/**/*.sarif

  create_issues:
    name: Create issues from CodeQL Alerts
    runs-on: ubuntu-latest
    needs: analyze
    permissions:
      contents: read
      security-events: read
      issues: write
    steps:
      - name: Create issues from Code Scanning alerts
        uses: actions/github-script@v7
        with:
          script: |
            const alerts = await github.paginate(
              github.rest.codeScanning.listAlertsForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "open",
                per_page: 100
              }
            );

            for (const alert of alerts) {
              const severity = alert.rule?.security_severity_level || "unknown";
              if (!["high", "critical"].includes(severity.toLowerCase())) continue;

              const ruleId = alert.rule?.id || "unknown-rule";
              const message = alert.most_recent_instance?.message?.text || "";
              const file = alert.most_recent_instance?.location?.path || "unknown file";

              const issueTitle = `CodeQL: [${severity.toUpperCase()}] ${ruleId}`;

              const { data: existingIssues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "open",
                labels: "auto-generated",
                per_page: 100
              });

              const duplicate = existingIssues.find(
                issue => issue.title === issueTitle
              );

              if (!duplicate) {
                const issueBody = `
                **${severity.toUpperCase()} CodeQL finding**
                **Rule:** ${ruleId}  
                **Message:** ${message}  
                **File:** ${file}  

                This issue was auto-created and assigned to **GitHub Copilot Autofix**.
                `;

                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  assignees: ["Copilot"],
                  labels: ["auto-generated", severity.toLowerCase()]
                });
              }
            }
